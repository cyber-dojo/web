<div id="traffic-lights"></div>

<script>
'use strict';
$(() => {

  const kata = cd.kata;

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // There are two sequences of traffic-lights:
  // o) kata-page traffic-lights live under #traffic-lights.
  //    Click any of these to open the diff-review
  // o) review-page traffic-lights live under #review-traffic-lights.
  //    Click any of these to move to it in the diff-review.
  // The first of these are controlled here.
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  const $lights = $('#kata-page #traffic-lights');

  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // cd.kata.appendTrafficLight() sets up the tip/click handlers
  // for the kata-page (but not review-page) traffic-lights.
  // It is called in these places:
  //   1) From views/kata/edit.html.erb
  //      - When the page loads.
  //   2) From views/kata/run_tests.js.erb
  //      - When you run the [test]s (and when there is a revert)
  //   3) From views/review/_checkout_button.html.erb
  //      - When you click [checkout].
  // - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  kata.appendTrafficLight = (light, option={scrollIntoView:false}) => {
    if (cd.lib.isVisible(light)) {
      let $light = $trafficLightImage(light);
      if (['pulling','timed_out','faulty'].includes(light.colour)) {
        $lights.append($light);
      }
      else if (cd.lib.hasPrediction(light)) {
        $lights.append(cd.lib.$predictImage(light));
        $lights.append($light);
      }
      else if (cd.lib.isRevert(light)) {
        $lights.append($light = cd.lib.$revertImage(light));
      }
      else if (cd.lib.isCheckout(light)) {
        if (light.checkout.id === kata.id) {
          $lights.append($light = cd.lib.$revertImage(light));
        } else {
          $lights.append($light = cd.lib.$checkoutImage(light));
        }
      }
      else {
        $lights.append($light);
      }
      if (option.scrollIntoView) {
        $light.scrollIntoView({
          direction: 'horizontal',
           duration: 'slow'
        });
      }
      kata.updateTrafficLightsCounts(light);
      kata.updatePredictCounts(light);
      $light.click(() => cd.review.fromTestPage(kata.id, light.index));
      cd.setupTrafficLightTip($light, light, kata.id, light.index-1, light.index);
    }
  };

  const $trafficLightImage = (light) => {
    return $('<img>', {
      class: 'diff-traffic-light',
        src: `/images/traffic-light/${light.colour}.png`,
        alt: `${light.colour} traffic-light`,
      'data-colour': light.colour, // Revert needs colour+index
      'data-index': light.index
    });
  };

});
</script>
