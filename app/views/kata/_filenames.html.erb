
<div id="filename-list"></div>

<script type="text/javascript">
'use strict';
$(() => {

  const filenames = cd.kata.filenames;

  filenames.sorted = () => cd.sortedFilenames();
  filenames.length = () => filenames.sorted().length;
  filenames.selected = () => $('.filename.selected').text().trim();
  filenames.top = () => filenames.sorted()[0];
  filenames.refresh = () => rebuildFilenameList();

  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // Filenames hot-key navigation
  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // See app/assets/javascripts/cyber-dojo_codemirror.js
  // See app/views/shared/_hotkeys.html.erb
  // Alt-J ==> selectNext()
  // Alt-K ==> selectPrevious()

  filenames.selectNext = () => filenames.select(nextFilename());
  filenames.selectPrevious = () => filenames.select(previousFilename());

  const indexOfSelected = () => filenames.sorted().indexOf(filenames.selected());
  const nextFilename = () => filenames.sorted()[indexOfNext()];
  const previousFilename = () => filenames.sorted()[indexOfPrevious()];

  const indexOfNext = () => {
    const index = indexOfSelected();
    if (index === -1) {
      return 0;
    } else {
      return (index + 1) % filenames.length();
    }
  };

  const indexOfPrevious = () => {
    const index = indexOfSelected();
    if (index === 0 || index === -1) {
      return filenames.length() - 1;
    } else {
      return index - 1;
    }
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  filenames.select = (filename) => {
    // Can't do $('radio_' + filename) because filename
    // could contain characters that aren't strictly legal
    // characters in a dom node id so I do this instead...
    $('.filename').removeClass('selected');
    const node = $(`[id="radio_${filename}"]`); // TODO: should be specific to filenames
    node.addClass('selected');
    setRenameAndDeleteButtons(filename);
    cd.kata.tabs.setFilename(filename);
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // cd.sortedFilenames()
  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // Returns how the filenames appear in the filename list.
  // Used in two places
  // 1. kata/edit page to help show filename-list
  // 2. review/show page/dialog to help show filename-list

  cd.filenames = () => cd.kata.editor.filenames();

  cd.sortedFilenames = (filenames) => {
    if (filenames === undefined) {
      filenames = cd.filenames(); // default arg
    }
    const trueFilenames = filenames.slice().filter(filename => !cd.isOutputFile(filename));
    trueFilenames.sort(orderer);
    return trueFilenames;
  };

  const orderer = (lhs,rhs) => {
    const lhsFileCat = fileCategory(lhs);
    const rhsFileCat = fileCategory(rhs);
    if (lhsFileCat < rhsFileCat) { return -1; }
    else if (lhsFileCat > rhsFileCat) { return +1; }
    else if (lhs < rhs) { return -1; }
    else if (lhs > rhs) { return +1; }
    else { return +1; }
  };

  const fileCategory = (filename) => {
    let category = undefined;
    if (isHighlightFile(filename))    { category = 1; }
    else if (isSourceFile(filename))  { category = 2; }
    else                              { category = 3; }
    // Special cases
    if (filename === 'readme.txt')    { category = 0; }
    // Shell test frameworks (eg shunit2) use .sh as their
    // extension but cyber-dojo.sh is always lowest category
    if (filename === 'cyber-dojo.sh') { category = 3; }
    return category;
  };

  const isHighlightFile = (filename) => {
    return cd.highlightFilenames().includes(filename);
  };

  const isSourceFile = (filename) => {
    return cd.extensionFilenames().find(ext => filename.endsWith(ext));
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -
  // new-file, rename-file, delete-file
  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  cd.fileCreate = (filename, file) => {
    cd.kata.editor.createFile(filename, file);
    filenames.refresh();
    filenames.select(filename);
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  cd.fileDelete = (filename) => {
    cd.kata.editor.deleteFile(filename);
    filenames.refresh();
    cd.kata.editor.showFile(filenames.top());
    filenames.select(filenames.top());
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  cd.fileRename = (oldFilename, newFilename) => {
    cd.kata.editor.renameFile(oldFilename, newFilename);
    cd.kata.editor.showFile(newFilename);
    filenames.refresh();
    filenames.select(newFilename);
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  const setRenameAndDeleteButtons = (filename) => {
    const disable = (node) => node.prop('disabled', true);
    const enable  = (node) => node.prop('disabled', false);
    if (cantBeRenamedOrDeleted(filename)) {
      disable(cd.renameFileButton());
      disable(cd.deleteFileButton());
    } else {
      enable(cd.renameFileButton());
      enable(cd.deleteFileButton());
    }
  };

  const cantBeRenamedOrDeleted = (filename) => {
    return cd.isOutputFile(filename) || filename === 'cyber-dojo.sh';
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  const rebuildFilenameList = () => {
    const selected = filenames.selected(); // Try to retain
    const sorted = cd.sortedFilenames();
    const filenameList = $('#filename-list');
    filenameList.empty();
    sorted.forEach(filename => filenameList.append(makeFilename(filename)));
    if (sorted.includes(selected)) {
      filenames.select(selected);
    } else {
      filenames.select(sorted[0]);
    }
  };

  const makeFilename = (filename) => {
    const div = $('<div>', {
        class: 'filename',
           id: `radio_${filename}`,
         text: filename
    });
    if (isHighlightFile(filename)) {
      div.addClass('highlight');
    }
    div.click(() => filenames.select(filename));
    return div;
  };

});
</script>
