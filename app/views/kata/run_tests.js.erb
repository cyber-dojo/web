
const appendTestTrafficLight = () => {
  const colour = "<%= @colour %>";
  const lightsCount = $('.diff-traffic-light').size();
  const img = $('<img>', {
    'src': '/images/bulb_' + colour + '.png',
    'alt': colour + ' traffic-light'
  });
  const div = $('<div>', {
    'class': 'diff-traffic-light',
    'data-tip'        : 'ajax:traffic_light',
    'data-id'         : "<%= @avatar.kata.id %>",
    'data-avatar-name': "<%= @avatar.name %>",
    'data-colour'     : colour,
    'data-was-tag'    : lightsCount,
    'data-now-tag'    : lightsCount + 1
  });
  const td = $('<td>');
  div.append(img);
  td.append(div);
  $('.traffic-lights-count').parent().before(td);
  cd.setupReviewTrafficLight(div);
  cd.setupHoverTip(div);
};

//- - - - - - - - - - - - - - - - - - - - - -

const updateTrafficLightCount = () => {
  $('.traffic-lights-count')
    .html("<%= js_partial('traffic_lights_count') %>");
};

const updateTrafficLightPieChart = () => {
  $('#traffic-lights-pie-chart')
    .html("<%= js_partial('traffic_lights_pie_chart') %>");
};

//- - - - - - - - - - - - - - - - - - - - - -

const addNewFiles = () => {
  $("#visible-files-container")
    .append("<%= js_partial('new_files') %>");
};

//- - - - - - - - - - - - - - - - - - - - - -

const removeDeletedFiles = () => {
  <% @deleted_files.keys.each do |filename| %>
    cd.deleteFile("<%= filename %>");
  <% end %>
};

//- - - - - - - - - - - - - - - - - - - - - -

const updateChangedFiles = () => {
  <% @changed_files.keys.each do |filename| %>
    cd.deleteFile("<%= filename %>");
  <% end %>
  $("#visible-files-container")
    .append("<%= js_partial('changed_files') %>");
};

//- - - - - - - - - - - - - - - - - - - - - -

$('#output').html("<%= js_partial('output') %>");

appendTestTrafficLight();
updateTrafficLightCount();
updateTrafficLightPieChart();

addNewFiles();
removeDeletedFiles();
updateChangedFiles();

cd.switchEditorToCodeMirror('output');
cd.scrollAvatarImageIntoView();

