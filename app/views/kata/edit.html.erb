
<%= render partial: 'test_button_handler' %>
<%= render partial: 'filename_support' %>

<script type="text/javascript"><!--

$(function() {

  cd.storeIncomingFileHashes();
  cd.storeOutgoingFileHashes();

  var filenames = cd.filenames();
  $.each(filenames, function(_,filename) {
    var file = cd.fileContentFor(filename);
    cd.bindHotKeys(file);
    if (filename != 'output') {
      cd.tabber(file);
    }
  });
  cd.bindAllLineNumbers();
  cd.rebuildFilenameList();

  var filename = filenames[cd.nonBoringFilenameIndex(filenames)];
  cd.loadFile(filename);

});

cd.switchEditorToCodeMirror = function(filename) {
<% if syntax_highlight_enabled? %>
  var editor = CodeMirror.fromTextArea(document.getElementById('file_content_for_' + filename),  {
    lineNumbers: true,
    matchBrackets: true,
    mode: cd.codeMirrorMode(filename),
    autoRefresh: true,
    theme: "default cyber-dojo"
  });

  editor.setOption("extraKeys", {
    'Alt-T': function(cm) {
      $('#test-button').click();
    }
  });

  var lineNumbers = document.getElementById(filename + '_line_numbers');
  lineNumbers.style.display = 'none';
<% end %>
};

cd.switchTheme = function() {
  var themeDropDown = document.getElementById('code-mirror-theme');
  var index = themeDropDown.selectedIndex;
  var selectedItem = themeDropDown.options[index];

  $.each($('.CodeMirror'), function(i, editor_div) {
    editor_div.CodeMirror.setOption("theme", 'default ' + selectedItem.value);
    editor_div.CodeMirror.refresh();
  });

};

//--></script>

<%= form_tag( { action: 'run_tests',
                id: @kata.id,
                avatar: @avatar.name
              } ) do %>

  <div id="kata-page">
    <%= render partial: 'test_spinner' %>
    <%= render partial: 'current_filename' %>
    <%= render partial: 'file_hashes_incoming' %>
    <%= render partial: 'file_hashes_outgoing' %>
    <table>
      <tr>
        <td class="align-right">
          <%= render partial: 'test_button' %>
        </td>
        <td>
          <div id="traffic-lights">
            <%= render partial: 'traffic_lights' %>
          </div>
        </td>
      </tr>
      <tr class="valign-top">
        <td class="align-right">
          <%= render partial: 'file_new_rename_delete' %>
          <%= render partial: 'filename_list' %>
        </td>
        <td>
          <%= render partial: 'editor' %>
        </td>
      </tr>
      <tr class="valign-top">
        <td class="align-right">
          <%= render partial: 'syntax_highlight_button' %>
        </td>
        <td class="align-right">
          <% if syntax_highlight_enabled? %>
            Theme:
            <select onChange="cd.switchTheme()" name="CodeMirrorTheme" id="code-mirror-theme">
              <option value="cyber-dojo" selected>cyber-dojo</option>
              <option value="">CodeMirror (default)</option>
            </select>
            <p>
              Syntax highlighting by <a href="http://codemirror.net" target="_blank">CodeMirror</a>.
              (<a href="https://raw.githubusercontent.com/codemirror/CodeMirror/master/LICENSE" target="_blank">License</a>)
            </p>
          <% end %>
        </td>
      </tr>
    </table>
  </div>

  <%= render partial: 'shared/footer_long',
             locals: {
                help_url:"http://blog.cyber-dojo.org/2014/10/the-cyber-dojo-test-page.html"
             } %>

<% end %>
