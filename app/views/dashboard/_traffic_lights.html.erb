<script type="text/javascript"><!--
'use strict';
$(() => {

  $('.diff-traffic-light').click(event => {
    const light = $(event.currentTarget);
    const id = light.data('id');
    const nowTag = light.data('tag');
    const wasTag = nowTag - 1;
    window.open(cd.showReviewUrl(id, wasTag, nowTag));
  });

  $('.avatar-image').click(event => {
    const id = $(event.currentTarget).data('id');
    const lastIndex = -1;
    window.open(cd.showReviewUrl(id, lastIndex, lastIndex));
  });

  cd.pieChart($('#traffic-lights .pie'));
  cd.setupHoverTips($('[data-tip]'));

  const allTheWay = 100000;
  $('#traffic-lights').scrollLeft(allTheWay);

});
//--></script>

<table>

  <% if @minute_columns == 'true' %>
    <tr>
      <% @time_ticks.keys.sort.each_with_index do |td_no,index| %>
  		  <% seconds = @time_ticks[td_no] %>
  		  <td class="<%= parity(index) %> column">
    	    <% if seconds.class == Hash %>
  	  	    <span class="collapsed-multi-gap"></span>
          <% else %>
            <div class='time-tick' data-tip="<%= raw time_tick(seconds) %>"></div>
          <% end %>
        </td>
      <% end %>
      <td></td>
      <td></td>
      <td>
        <div class='age'
             data-tip="time between<br/>the oldest and newest<br/>traffic-lights">
             <%= raw time_tick(@group.age) %>
           </div>
      </td>
    </tr>
  <% end %>

  <% @gapped.keys.sort.each do |name| %>
	<tr>
	  <% lights = @all_lights[name] %>
	  <% td_map = @gapped[name] %>
    <% kata_id = lights[-1].kata.id %>

	  <% td_map.keys.sort.each_with_index do |td_no,index| %>
		  <% td = td_map[td_no] %>

		  <td class="<%= parity(index) %> column">
		  <% if td.class == Hash %>
		    <span class="collapsed-multi-gap"></span>
		  <% end %>
		  <% if td.class == Array %>
		    <% if td.length == 0 %>
			    <div class="gap"></div>
		    <% else %>
          <table align="right">
            <tr>
				    <% td.each do |light| %>
              <td><%= raw diff_traffic_light(light) %></td>
            <% end %>
            </tr>
          </table>
		    <% end %>
		  <% end %>
		  </td>
	  <% end %>

    <td class="align-right">
      <%= raw traffic_light_count(lights) %>
    </td>
    <td class="align-center">
      <%= raw pie_chart(lights) %>
    </td>
    <td class="align-left valign-center">
      <%= raw diff_avatar_image(kata_id, name) %>
    </td>

	</tr>
  <% end %>
</table>
