<div id="review-traffic-lights"></div>

<script>
'use strict';
$(() => {

  const review = cd.review;

  const $lights = $('#review-traffic-lights');

  review.trafficLights = {
    refresh: () => {
      review.getJSON('model', 'kata_events', {id:review.id}, (events) => {
        if (review.index === -1) {
          review.index = events.length - 1; // Need by [fork] and [checkout]
        }
        $lights.empty();
        appendTrafficLights(events);
        scrollCurrentTrafficLightIntoView();
        review.refreshTrafficLightsNavigator(events);
      });
    }
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -
  const appendTrafficLights = (events) => {
    review.checkoutButton.enable();
    events.forEach(event => {
      if (cd.lib.isVisible(event)) {
        const light = event;
        const $light = cd.lib.appendTrafficLight($lights, light);
        $light.click(() => review.refresh(review.id, light.index));
        cd.setupTrafficLightTip($light, light, review.id, light.index-1, light.index);
        if (review.index === light.index) {
          $trafficLightMarkerHtml(light).insertAfter($light);
          if (isOwnRevertedIncorrectPredictionLight(event)) {
            review.checkoutButton.disable();
          }
        }
      }
    });
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -
  const $trafficLightMarkerHtml = (light) => {
    return $('<img>', {
      id: 'traffic-light-marker',
      src: `/images/traffic-light/marker_${light.colour}.png`
    });
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -
  const isOwnRevertedIncorrectPredictionLight = (light) => {
    const predictedWrong    = (light.colour != light.predicted);
    const wasReverted       = (light.revert_if_wrong === 'on');
    const reviewingOwnLight = (cd.kata.id === review.id);
    return cd.lib.hasPrediction(light)
        && predictedWrong
          && wasReverted
            && !review.isIndependent()
              && reviewingOwnLight;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -
  const scrollCurrentTrafficLightIntoView = () => {
    // refreshTrafficLights() has updated the dom with a $('#traffic-light-marker')
    // I cannot find a nice way to access it once the dom is ready. So this :-(
    const quarterSecond = 250;
    const scroller = () => {
      $('#traffic-light-marker').scrollIntoView({
        direction: 'horizontal',
         duration: 'slow'
      });
    };
    setTimeout(scroller, quarterSecond);
  };

});
</script>
