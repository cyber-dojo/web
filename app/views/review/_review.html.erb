<script type="text/javascript"><!--
'use strict';
$(() => {

  //---------------------------------------------------------------------
  // This review page doubles as a review *dialog* from the kata/edit
  // page traffic-light click handlers.
  // Everywhere else review is its own *page* with its own URL.
  // The [revert] button is available only from the review *dialog*.
  //---------------------------------------------------------------------

  let param = {
          id: "<%= @kata.id %>",
      avatar: "<%= @kata.avatar_name %>",
      wasTag: "<%= @was_tag %>",
      nowTag: "<%= @now_tag %>",
    filename: "<%= @filename %>"
  };

  // after refresh() has been called param also contains param.events
  // which is an array of events where events[i].index is the event index.

  cd.setReviewDialogData = (id, avatar, wasTag, nowTag, filename) => {
    param = {
            id:id,
        avatar:avatar,
        wasTag:wasTag,
        nowTag:nowTag,
      filename:filename
    };
    reviewRefresh();
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const show = (tag) => {
    param.nowTag = tag;
    // preserve diff on/off state
    if (diffCheckBox().is(':checked')) {
      const prev = getPrevTag()
      param.wasTag = (prev !== null) ? prev : 0;
    } else {
      param.wasTag = tag;
    }
    refresh();
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const refresh = () => {
    if (inDialog()) {
      reviewRefresh();
    } else {
      window.location.href =
        cd.showReviewUrl(
          param.id,
          param.wasTag,
          param.nowTag,
          param.filename
        );
    }
  };

  //-----------------------------------------
  // refresh diff? [x]
  //-----------------------------------------

  const refreshDiffCheckBox = () => {
    diffCheckBox()
      .attr('checked', inDiffMode())
      .unbind('click')
      .bind('click', () => show(param.nowTag));
  };

  const diffCheckBox = () => $('#diff-checkbox');

  const inDiffMode = () => param.wasTag != param.nowTag;

  //-----------------------------------------
  // refresh traffic-lights
  //-----------------------------------------

  const refreshTrafficLights = () => {
    const trafficLights = $('#review-traffic-lights');
    trafficLights.html(makeTrafficLightsHtml(param.events));
    $.each($('.diff-traffic-light'), (_, light) => {
      const $light = $(light);
      const nowTag = $light.data('now-tag');
      $light.click(() => show(nowTag));
    });
    cd.setupHoverTips($('[data-tip]')); // lights + other tips
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const makeTrafficLightsHtml = (events) => {
    // Displays all the events that it receives from the differ/diff
    // JSON call and sets up was/now index for each event with the
    // was-index simply being the previous event index.
    // Note that event.indexs will not be contiguous if events
    // contains non-test events.
    let html = '';
    let wasTag = 0;
    let lastColour = '';
    let trafficLightCount = 0;
    html += '<table><tr>';
    $.each(events, (_n, event) => {
      const colour = event.colour;
      const nowTag = event.index;
      const barGap = (param.nowTag === nowTag) ? 'bar' : 'gap';
      html +=
        "<td><div class='diff-traffic-light'" +
              " data-tip='ajax:traffic_light'" +
              ` data-id='${param.id}'` +
              ` data-avatar-name='${param.avatar}'` +
              ` data-colour='${colour}'` +
              ` data-was-tag='${wasTag}'` +
              ` data-now-tag='${nowTag}'>` +
          "<img class='with-bar-gap' src='/images/bulb_" + colour + '_' + barGap + ".png'/>" +
        '</div></td>';
      wasTag = nowTag;
      lastColour = event.colour;
      trafficLightCount++;
    });

    // I have tried making the traffic-light-count below into
    // a hover-tip to match the kata/edit and dashboard pages.
    // For some reason the hover-tip gets displayed behind
    // the file-diff.
    html += '<td>';
    html += `<div class='traffic-light-count ${lastColour}'>`;
    html += trafficLightCount;
    html += '</div>';
    html += '</td>';
    html += '</tr></table>';

    return html;
  };

  //-----------------------------------------
  // refresh [<] avatar [>]
  //-----------------------------------------

  const refreshAvatarControls = () => {
    if (param.avatar === '') {
      $('#avatar-control').hide();
    } else {
      refreshPrevAvatarHandler();
      refreshAvatarImage();
      refreshNextAvatarHandler();
    }
  };

  const refreshAvatarImage = () => {
    $('#avatar').parent().html(makeAvatarImageHtml());
  };

  const makeAvatarImageHtml = () => {
    return `<img id="avatar" src="/images/avatars/${param.avatar}.jpg"/>`;
  };

  const refreshPrevAvatarHandler = () => {
    refreshAvatarHandler('prev', param.prevKataId);
  };

  const refreshNextAvatarHandler = () => {
    refreshAvatarHandler('next', param.nextKataId);
  };

  const refreshAvatarHandler = (direction, id) => {
    $(`#${direction}-avatar`)
      .attr('disabled', id === '')
      .unbind('click')
      .bind('click', () => {
        param.id = id;
        if (inDiffMode()) {
          // Move to the new avatar's first tag.
          // tag zero is created for an avatar when it joins a session.
          // I am assuming that this review page/dialog will only ever
          // be displayed for a tag greater than zero, that is, for a
          // tag corresponding to an actual kata/edit event, even if
          // that event is a non-test event.
          show(1);
        } else {
          // Move to the new avatar's last event.
          // Note: the refresh() will cause nowTag/wasTag to become
          // the actual last event.index (rather than -1).
          // Note: The param.avatar is set above but the
          // param.events array will not match param.avatar until
          // after refresh() has completed (which is an async call).
          const lastIndex = -1;
          param.wasTag = lastIndex;
          param.nowTag = lastIndex;
          refresh();
        }
      });
  };

  //-----------------------------------------
  // refresh [<] tag [>]
  //-----------------------------------------
  // [<] is enabled if there is a useable tag to the lhs of param.nowTag
  // [>] is enabled if there is a useable tag to the rhs of param.nowTag
  //-----------------------------------------

  const refreshTagControls = () => {
    const prevTag = getPrevTag();
    const nextTag = getNextTag();
    refreshTag($('#prev-tag'), prevTag);
    $('#tag-number-container').html(tagHtml());
    refreshTag($('#next-tag'), nextTag);
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const getPrevTag = () => {
    const index = indexForTag(param.nowTag);
    if (index === null || index === 0)
      return null;
    else
      return param.events[index - 1].index;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const getNextTag = () => {
    const index = indexForTag(param.nowTag);
    if (index === null || index === param.events.length - 1)
      return null;
    else
      return param.events[index + 1].index;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const indexForTag = (number) => {
    // Finds the index of the tag in the param.events array
    // whose tag.number equals the number argument.
    let index = null;
    for (let i = 0; i < param.events.length; i++) {
      if (param.events[i].index === number) {
        index = i;
        break;
      }
    }
    return index;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const tagHtml = () => {
    return tagTrafficLightHtml(param.nowTag);
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const tagTrafficLightHtml = (tagNumber) => {
    const index = indexForTag(tagNumber);
    const colour = (index === null) ? '' : param.events[index].colour;
    return `<div id="tag-number" class="${colour}">${tagNumber}</div>`;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const refreshTag = (button, newTag) => {
    const on = newTag !== null;
    button
      .attr('disabled', !on)
      .css('cursor', on ? 'pointer' : 'default');
    if (on) {
      button
        .unbind('click')
        .bind('click', () => show(newTag));
    }
  };

  //-----------------------------------------
  // refresh files
  //-----------------------------------------

  const refreshFiles = () => {
    const diffContent = $('#diff-content');
    const diffFilenames = $('#diff-filenames');
    diffFilenames.html(makeDiffFilenames(param.diffs));
    resetFilenameAddedDeletedLineCountHandlers();
    diffContent.html(makeDiffContent(param.diffs));
    buildDiffFilenameHandlers(param.idsAndSectionCounts);
    showFile(param.currentFilenameId);
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const makeDiffFilenames = (diffs) => {
    // align-right is for diff toggling added/deleted line counts
    return '' +
      '<table align="right">' +
        '<tr>' +
            makeTd(makeDiffFilenamesColumn(diffs)) +
            makeTd(makeDiffDeletedCountColumn(diffs)) +
            makeTd(makeDiffAddedCountColumn(diffs)) +
        '</tr>' +
      '</table>';
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const makeDiffFilenamesColumn = (diffs) => {
    let html = '';
    html += '<table>';
    $.each(sortedDiffs(diffs), (_, diff) => {
      const td = $('<td>');
      const filenameDiv =
        $('<div>', {
            'class': 'filename',
            'data-filename': diff.filename,
            'id': `radio_${diff.id}`,
            'text': diff.filename
        });
      td.append(filenameDiv);
      html += makeTr(td.html());
    });
    html += '</table>';
    return html;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const makeDiffDeletedCountColumn = (diffs) => {
    return makeDiffCountColumn(diffs, 'deleted_line_count', 'deleted');
  };

  const makeDiffAddedCountColumn = (diffs) => {
    return makeDiffCountColumn(diffs, 'added_line_count', 'added');
  };

  const makeDiffCountColumn = (diffs, propertyName, cssName) => {
    let html = '';
    if (!diffCheckBox().is(':checked')) {
      return html;
    }
    html += '<table>';
    $.each(sortedDiffs(diffs), (_, diff) => {
      const count = diff[propertyName];
      const td = $('<td>');
      const noneOrSome = (count === 0) ? 'none' : 'some';
      const div = $('<div>', {
        'class': `diff-${cssName}-line-count ${noneOrSome} button`,
        'data-filename': diff.filename
      });
      div.append(count);
      td.append(div);
      html += makeTr(td.html());
    });
    html += '</table>';
    return html;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const sortedDiffs = (diffs) => {
    let filenames = [];
    $.each(diffs, (_, diff) => {
      filenames.push(diff.filename);
    });
    // ensure filenames appear in the same order as kata/edit page
    const sorted = cd.sortedFilenames(filenames);
    const diffFor = (filename) => {
      for (let i = 0; i < diffs.length; i++) {
        if (diffs[i].filename === filename) {
          return diffs[i];
        }
      }
    };
    let result = [];
    $.each(sorted, (_, filename) => {
      result.push(diffFor(filename));
    });
    return result;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const resetFilenameAddedDeletedLineCountHandlers = () => {

    const display = (node, name, value) => {
      if ($(node).attr('disabled') != 'disabled') {
        const filename = $(node).data('filename');
        const selector = `[id="${filename}_diff_div"] ${name}`;
        $(selector).css('display', value);
      }
    };

    $('.diff-deleted-line-count')
      .clickToggle(
        function() { display(this, 'deleted', 'none' ); },
        function() { display(this, 'deleted', 'block'); }
      );

    $('.diff-added-line-count')
      .clickToggle(
        function() { display(this, 'added', 'none' ); },
        function() { display(this, 'added', 'block'); }
      );
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const buildDiffFilenameHandlers = (diffs) => {
    // Builds click handlers for all filenames for a given
    // [ kata-id, animal-name, was-tag, now-tag] tuple.
    // When you open a new filename it auto-scrolls its first diff-chunk.
    // When you reclick a filename it auto-scrolls to its *next* diff-chunk.
    const getFilename = (node) => $.trim(node.text());
    const id = (name) => $(`[id="${name}"]`);
    const diffFileContentFor = (filename) => id(`diff_file_content_for_${filename}`);
    const diffFileDiv = (filename) => id(`${filename}_diff_div`);

    let previousFilenameNode;
    let alreadyOpened = [];

    const loadFrom = (diff) => {
      const id = diff.id;
      const filenameNode = $(`#radio_${id}`);
      const filename = getFilename(filenameNode);
      const sectionCount = diff.section_count;
      const diffSheet = diffFileContentFor(filename);
      let sectionIndex = 0;

      if (sectionCount > 0) {
        filenameNode.attr('title', 'Auto-scroll through diffs');
      }

      return () => {

        const reselected =
          previousFilenameNode != undefined &&
            getFilename(previousFilenameNode) == filename;

        $('.diff-deleted-line-count, .diff-added-line-count').attr('disabled', true);
        $('.diff-deleted-line-count[data-filename="'+filename+'"]').attr('disabled', false);
        $('.diff-added-line-count[data-filename="'+filename+'"]').attr('disabled', false);

        cd.radioEntrySwitch(previousFilenameNode, filenameNode);

        if (previousFilenameNode != undefined) {
          diffFileDiv(getFilename(previousFilenameNode)).hide();
        }
        diffFileDiv(getFilename(filenameNode)).show();
        previousFilenameNode = filenameNode;
        param.filename = filename;

        if (sectionCount > 0 && (reselected || !cd.inArray(filename, alreadyOpened))) {
          const section = $(`#${id}_section_${sectionIndex}`);
          const downFromTop = 250;
          const halfSecond = 500;
          diffSheet.animate({
            scrollTop: '+=' + (section.offset().top - downFromTop) + 'px'
          }, halfSecond);
          sectionIndex += 1;
          sectionIndex %= sectionCount;
        }
        alreadyOpened.push(filename);
      };
    }; // loadFrom()

    $.each(diffs, (_n, diff) => {
      const filename = $(`#radio_${diff.id}`);
      filename.click(loadFrom(diff));
    });
  }; // buildDiffFilenameHandlers()

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const makeDiffContent = (diffs) => {
    const holder = $('<span>');
    $.each(diffs, (_, diff) => {
      const table = $('' +
        '<div id="' + diff.filename + '_diff_div" class="filename_div">' +
        '<table>' +
          '<tr class="valign-top">' +
            makeTd('<div class="diff-line-numbers"></div>') +
            makeTd('<div id="diff_file_content_for_' + diff.filename + '"' +
                   ' class="diff-sheet"></div>') +
          '</tr>' +
        '</table>' +
        '</div>'
        );
      const content = $('.diff-sheet', table);
      const numbers = $('.diff-line-numbers', table);
      content.html(diff.content);
      numbers.html(diff.line_numbers);
      bindLineNumberScrolling(content, numbers);
      holder.append(table);
    });
    return holder;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const bindLineNumberScrolling = ($content, $numbers) => {
    const synchScroll = () => {
      $numbers.scrollTop($content.scrollTop());
    };
    $content.bind({
      keydown   : synchScroll,
      scroll    : synchScroll,
      mousewheel: synchScroll,
      mousemove : synchScroll,
      mousedown : synchScroll,
      mouseup   : synchScroll
    });
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const showFile = (filenameId) => {
    const filename =  $(`#radio_${filenameId}`);
    filename.click()
            .scrollIntoView({ direction: 'vertical' });
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const reviewRefresh = () => {
    const reviewParams = {
            id: param.id,
        avatar: param.avatar,
       was_tag: param.wasTag,
       now_tag: param.nowTag,
      filename: param.filename
    };
    $('.ui-dialog').addClass('busy');
    $.getJSON('/differ/diff', reviewParams, (data) => {
      $('.ui-dialog').removeClass('busy');
      param = data;
      refreshTrafficLights();
      refreshDiffCheckBox();
      refreshTagControls();
      refreshAvatarControls();
      refreshFiles();
      refreshForkButton();
      refreshRevertButton();
      refreshDownloadButton();
      const tag = $('img[src $= "_bar.png"]');
      const options = { direction: 'horizontal', duration: 'slow' };
      tag.scrollIntoView(options);
    });
  };

  //-----------------------------------------
  // refresh [fork] {create a new practice-session}
  //-----------------------------------------

  const refreshForkButton = () => {
    const button = $('#fork-button');
    cd.setTip(button, () => {
      const tip = `setup a new session from ${param.avatar} ${param.nowTag}`;
      cd.showHoverTip(button, tip);
    });
  };

  //-----------------------------------------
  // refresh [revert] (from dialog only)
  //-----------------------------------------

  const refreshRevertButton = () => {
    const button = $('#revert-button');
    cd.setTip(button, () => {
      const tip = `revert to ${param.avatar} ${param.nowTag}`;
      cd.showHoverTip(button, tip);
    });
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const doRevert = () => {
    const revertParams = {
          id: param.id,
      avatar: param.avatar,
         tag: param.nowTag
    };
    $.getJSON('/reverter/revert', revertParams, (data) => {
      // This is .dialog('close') and NOT .remove() since the
      // latter breaks inDialog()'s dialog.size() === 1 check.
      $('#review-dialog').dialog('close');
      deleteAllCurrentFiles();
      copyRevertFilesToCurrentFiles(data.visibleFiles);
      $('#test-button').click();
    });
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const deleteAllCurrentFiles = () => {
    cd.eachFilename((filename) => {
      if (!isOutputFile(filename)) {
        cd.deleteFile(filename);
      }
    });
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const isOutputFile = (filename) => {
    return ['stdout','stderr','status'].includes(filename);
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const copyRevertFilesToCurrentFiles = (visibleFiles) => {
    for (const filename in visibleFiles) {
      cd.newFile(filename, visibleFiles[filename]);
    }
  };

  //-----------------------------------------
  // refresh [download]
  //-----------------------------------------

  const refreshDownloadButton = () => {
    const button = $('#download-button');
    cd.setTip(button, () => {
      const tip = `download files from ${param.avatar} ${param.nowTag}`;
      cd.showHoverTip(button, tip);
    });
  };

  const doDownload = () => {
    const url = `/download_tag/${param.id}/${param.avatar}/${param.nowTag}`;
    window.location = url;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const setupButton = (name, handler) => {
    $('#'+name+'-button-container').html('<button id="'+name+'-button" type="button"></button>');
    $('#'+name+'-button')
      .text(name)
      .unbind('click')
      .bind('click', handler);
    if (name === 'download') { refreshDownloadButton(); }
    if (name === 'fork') { refreshForkButton(); }
    if (name === 'revert') { refreshRevertButton(); }
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const makeTr = (html) => `<tr>${html}</tr>`;
  const makeTd = (html) => `<td>${html}</td>`;

  // - - - - - - - - - - - - - - - - - - - - - - - -

  const inDialog = () => $('div.ui-dialog-content').size() === 1;

  // - - - - - - - - - - - - - - - - - - - - - - - -

  if (inDialog()) {
    setupButton('revert', () => doRevert());
    setupButton('close',  () => $('#review-dialog').dialog('close'));
  } else {
    reviewRefresh();
  }
  setupButton('download', () => doDownload());
  setupButton('fork',     () => cd.forkDialog(param.id, param.avatar, param.nowTag));

});

//--></script>

<%= render(:partial => 'shared/extension_filenames') %>
<%= render(:partial => 'review/buttons') %>

<table>
  <tr valign="top">
    <td align="right" style="width:300px" rowspan="2">
      <%= render(:partial => 'review/navigate_control') %>
      <%= render(:partial => 'review/diff_checkbox') %>
      <div id="diff-filenames"></div>
    </td>
    <td>
      <div id="review-traffic-lights"></div>
    </td>
  </tr>
  <tr valign="top">
    <td>
      <div id="diff-content"></div>
    </td>
  </tr>
</table>
