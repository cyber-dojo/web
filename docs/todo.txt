
Note: app/controllers/application_controller.rb container render 404, 500
Need to improve dialog-box errors, eg when you get a server 500

------------------------------------------------------------------
NOTE: saver.ran_test2() is ENABLED
Breaks app-controller tests for revert
  1) Failure:
ReverterTest#test_'81F276',
 in individual kata, revert back to our own previous traffic-light
 [reverter_test.rb:91]:
Expected: ["lBsH1E", 2]
  Actual: ["lBsH1E", 3]  

Note: You do not get an extra EVENT for prediction.
      You get extra 'predicted'=>'red' in the event

Use cases:
 ran_tests() with prediction, wrong, no edit-event 
   3(green)         4(amber, predict=red) 5(back to 3) ==-2
 ran_tests() with prediction, wrong, with edit-event
   3(green) 4(edit) 5(amber, predict=red) 6(wrong-prediction) 6(back to 3) ==-3


Note: kata.revert is ALSO used for explicit [revert] in review page.

kata.runTests() is in app/views/kata/_run_tests.html.erb
  makes an $.ajax call then runs app/views/kata/run_tests.js.erb:

  refreshFromTest();
  if (runNeedsReverting()) {
    revert();
  }

  const refreshFromTest = () => {
    cd.kata.setIndex(light.index + 1);
    ...
  };

  const revert = () => {
    const args = {
      id: cd.kata.id,      // eg 'Xd4f2P'
      index: cd.kata.index // eg 18 (reverting to 16)
    };
    $.post('/kata/revert', args, (data) => {
      cd.kata.incrementIndex(); <<<<<
      cd.kata.editor.deleteFiles();
      for (const filename in data.files) {
        cd.kata.editor.createFile(filename, { content:data.files[filename] });
        cd.kata.editor.showFile(filename);
      }
      cd.kata.filenames.refresh();
      cd.kata.editor.output(data.stdout.content, data.stderr.content, data.status);
      cd.kata.tabs.output().click();
      cd.kata.appendTrafficLight(data.light, {scrollIntoView:true});
    }, 'json');
  };

kata_controller.revert() looks like this:

  def revert
    # Eg [14=green], [15=incorrect prediction], [index=16 ==> revert to 14]
    args = [id, index - 2]
    json = source_event(id, index - 2, :revert, args)
    saver.kata_reverted(id, index, @files, @stdout, @stderr, @status, {
      colour: @colour,
      revert: args
    });
    render json: json
  end

  def source_event(src_id, src_index, name, value)
    event = saver.kata_event(src_id, src_index)
    @files = event['files']
    @stdout = event['stdout']
    @stderr = event['stderr']
    @status = event['status']
    @colour = event['colour']
    {
       files: @files.map{ |filename,file| [filename, file['content']] }.to_h,
      stdout: @stdout,
      stderr: @stderr,
      status: @status,
       light: {
         colour: @colour,
          index: index,
          name => value
       }
    }
  end

which is hard-wiring the index-2 and sometimes it needs to be index-3


------------------------------------------------------------------

Any remaining app-controller tests use RunnerService when they could use RunnerStub?
Are some tests are failing because they are not using v2 manifests? Use v2 in all tests

- From demo, if you add a new traffic-lights by hitting [test] 
  these get the correct RAG and diff tool-tip. But if you click it
  then in review mode, when you select one of these new RAGs, 
  with diff[x] on, then you get no diff in the files. You should. 

- Refactor JS so refresh methods are called only when needed.

- When extras[x] is checked and you are on an inter-test-event 
  and you turn off extras[ ] then you need to change the index 
  going to the previous/next RAG or no traffic-light gets an underbar

- In avatar-navigator, when [<] [>] is selected, JS code currently
  hard-wires the index to ? (1 : avatar.events.length - 1);
  This needs to use traffc-light functions.

- Selection of highlight filename when file-events are enabled needs reworking.
  When diff[x] is off:
    create -> created-filename: The file is not selected
    delete -> deleted-filename: The file is not selected
    rename -> renamed-filename: The file is not selected. No tooltip for the old filename
    edit   ->  edited-filename: The file is not selected.
  Should diff[x] be fixed to on when in details[x] is on?

- drop CDRE icon from diff-tool-tip?
- s/file_edit/edit file/ in diff-tool-tip?

- stdout/stderr/status appear below the file knave when reviewing 
  an inter-test-event index. They should not.

- could the inter-test-events store the number of lines added/deleted 
  in the events.json summary? This would enable fast calculation of 
  RAG<->RAG stats, eg on a dashboard.
  $ git diff --help
  says it can show diffs between a commit and a worktree.
  --shortstat option gives 
  1 file changed, 3 insertions(+), 2 deletions(-)

------------------------------------------------------------------
      
- check how revert handles logic to know if reverting to specific 
  traffic-lights is allowed or not.
- comment out JS calls to file-create/delete/rename/edit 
  and do careful check that everything still works: revert,checkout,predict,etc
  and then do a release
- ? make saver.ran_tests() create two events, file-edit, and then a colour
  release that
- ? turn on file-create/delete/rename/edit

------------------------------------------------------------------

- handle auto-revert on [test] page.
Have to think about how to handle auto-revert on the kata page 
(when [test] is pressed).
Do I go back to the previous traffic-light (even if there are inter-test-events)?
That would retain current behaviour from the edit page point of view.
What other options are there?

------------------------------------------------------------------

checkout is prevented if it undoes an auto-revert.
Suppose RAG -> RAG was 6->7->8 where 8 is same as 6
then you are prevented from checking out 7.
Suppose RAG -> RAG is now 6 -> ite(7,8,9) -> 10 -> 11 where 11 is same as 6.
Are you now prevented from checking out 7,8,9,10 ?
Or should this restriction be turned off completely?

------------------------------------------------------------------

Note: all web code is on a branch and so is not even on beta yet.
When it is deployed to beta/prod then inter-test-events will start to
be created, since saver has inter-test-events in beta/prod already.

------------------------------------------------------------------

Upgrade demo to bring up a v2 kata with inter-test events.
Use it to get into review page for working on showing inter-test events.
Have to think about how to handle [revert]
Do I allow revert from an inter-test event? I think yes.
Will need (C)(D)(R)(E) icons with an underbar.

------------------------------------------------------------------

In a v2 kata, if you create inter-test-events, and traffic-lights are at
indexes 2,4,7 then these indexes are visible in the diff-tool-tip.
If you click light(eg index=4) then in review mode you see that light 
underbarred and the navigator-index shown is 4.
You can use [<][>] to navigate to a non-test-event and
- the diff is shown
- the index will update
- the underbar will be removed.
Perhaps this is almost enough?!
Could extra[x] only control what the underlying events are?

------------------------------------------------------------------

In review-mode, always do diff-summary of index-1,index
and always show file-type markers. Make the diff[x] checkbox
control whether the [+][-] diffs are visible. Need to try this.
What about [+] created files and [-] deleted files?

Polyfill old checkouts on model?
