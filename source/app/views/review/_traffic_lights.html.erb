<div id="review-traffic-lights"></div>

<script>
'use strict';
$(() => {

  const review = cd.review;

  const $lights = $('#review-traffic-lights');

  review.trafficLights = {
    refresh: () => {
      if (review.index === -1) {
        review.index = review.events.length - 1; // Need by [fork] and [checkout]
      }
      $lights.empty();
      appendTrafficLights(review.events); // TODO: only need to do this for new avatar
      scrollCurrentTrafficLightIntoView();
      review.refreshTrafficLightsNavigator();
    }
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -
  const appendTrafficLights = (events) => {
    review.checkoutButton.enable();
    review.trafficLightsCounts.reset();
    review.predictCounts.reset();

    events.forEach(event => {
      if (isVisible(event)) {
        const light = event;
        const isCurrentIndex = (review.index === light.index);
        const $light = cd.lib.appendTrafficLight($lights, light, {isCurrentIndex:isCurrentIndex});
        $light.click(() => review.refresh(review.id, light.index));      
        cd.setupTrafficLightTip($light, light, review.id, review.previousIndex(light.index), light.index);

        if (light.index <= review.index) {
          cd.review.trafficLightsCounts.update(light);
          cd.review.predictCounts.update(light);
        }
        if (isOwnRevertedIncorrectPredictionLight(light)) {
          review.checkoutButton.disable();
        }
      }
    });
  };

  review.previousIndex = (index) => {
    if (index == 0) {
      return 0;
    } else if (review.detailsCheckBox.isChecked()) {
      return index - 1;
    } else {
      return index - 1 - review.events[index - 1].minor_index;
    }
  };

  const isVisible = (event) => {
    if (cd.lib.isLight(event)) {
      return true;
    } else if (cd.lib.isFileEvent(event) && review.detailsCheckBox.isChecked()) {
      return true;
    } else {
      return false;
    }
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -
  const isOwnRevertedIncorrectPredictionLight = (light) => {
    const isCurrentIndex    = (review.index === light.index);
    const predictedWrong    = (light.colour != light.predicted);
    const wasReverted       = (light.revert_if_wrong === 'on');
    const reviewingOwnLight = (cd.kata.id === review.id);
    return isCurrentIndex
      && cd.lib.hasPrediction(light)
        && predictedWrong
          && wasReverted
            && !review.isFromDashboard()
              && reviewingOwnLight;
  };

  // - - - - - - - - - - - - - - - - - - - - - - - -
  const scrollCurrentTrafficLightIntoView = () => {
    // refreshTrafficLights() has updated the dom with a $('#traffic-light-marker')
    // I cannot find a nice way to access it once the dom is ready. So this :-(
    const quarterSecond = 250;
    const scroller = () => {
      $('#traffic-light-marker').scrollIntoView({
        direction: 'horizontal',
         duration: 'slow'
      });
    };
    setTimeout(scroller, quarterSecond);
  };

});
</script>
