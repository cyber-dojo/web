<button id="fork-button" type="button">fork</button>

<div id="fork-dialog" style="display:none;">
  <div class="info">
    create a new practice<br/>
    from this traffic-light&#39;s files
  </div>
  <button class="kata"  type="button">ensemble style</button>
  <button class="group" type="button">classroom style</button>
  <button class="kata"  type="button">solo style</button>
</div>

<script>
'use strict';
$(() => {

  const kata = cd.kata;
  const review = cd.review;

  //- - - - - - - - - - - - - - - - - - - - - - - - -
  // NB: logically there are other possibilities here...
  // - In a classroom practice, you could fork a new avatar (in that group)
  // - A "Deep-Fork" where the new session has the full git
  //   history of the forked-from session.
  // At present, there is no support for either of these.

  const $button = $('#fork-button');
  const $fork = $('#fork-dialog');

  const refreshToolTip = () => {
    cd.createTip($button, () => {
      return `Create a <u>new</u> practice from<br/>${review.nameRagColour()}`;
    });
  };

  review.forkButton = {
    enable: () => $button.prop('disabled', false),
    disable: () => $button.prop('disabled', true),
    refresh: () => {
      refreshToolTip();
      if (cd.env['FORK_BUTTON'] == 'off') {
        $button.hide();
      }
      if (review.isOnFileEvent()) {
        review.forkButton.disable();
      }
      else {
        review.forkButton.enable();
      }
    }
  };

  const openForkDialog = () => {
    const xPos = $button.offset().left;
    const yPos = $button.offset().top + 30;
    $fork.dialog({
              title: cd.dialogTitle('fork'),
              width: 270,
             height: 350,
              modal: true,
           autoOpen: true,
           position: [ xPos, yPos ],
      closeOnEscape: true,
    });
  };

  const fork = (type) => {
    $fork.dialog('close');
    const method = `${type}_fork`;
    $.ajax({
            type: 'POST',
             url: `/saver/${method}?id=${cd.review.id}&index=${cd.review.index}`,
        dataType: 'json', // format we want response in
           async: true,
           error: error,
         success: (response) => {
           const id = response[method];
           if (id) {
             window.open(`/creator/enter?id=${id}`);
           }
           else {
             cd.dialogError(response);
           }
        }
    });
  };

  const error = (request, status, thrown) => {
    const message = [
      request.responseText,
      '----------------------------',
      `Status=${status}`,
      thrown
    ].join("\n");
    cd.dialogError(message);
  };

  //- - - - - - - - - - - - - - - - - - - - - - - - -
  $button.click(() => openForkDialog());
  $('.kata' , $fork).click(() => fork('kata'));
  $('.group', $fork).click(() => fork('group'));

});
</script>
